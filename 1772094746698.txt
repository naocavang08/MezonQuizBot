-- ──── ENUM TYPES ──────────────────────────────────────────
CREATE TYPE quiz_visibility AS ENUM ('private', 'public', 'unlisted');
CREATE TYPE quiz_status AS ENUM ('draft', 'published', 'archived');
CREATE TYPE session_status AS ENUM ('waiting', 'active', 'paused', 'finished', 'cancelled');

-- ──── AUTH & RBAC ─────────────────────────────────────────

CREATE TABLE users (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mezon_user_id   VARCHAR(255) UNIQUE NOT NULL,
  email           VARCHAR(255) UNIQUE,
  username        VARCHAR(255) NOT NULL,
  display_name    VARCHAR(255),
  avatar_url      TEXT,
  is_active       BOOLEAN DEFAULT true,
  last_login_at   TIMESTAMP,
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);

CREATE TABLE roles (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name            VARCHAR(50) UNIQUE NOT NULL,
  display_name    VARCHAR(100),
  description     TEXT,
  is_system       BOOLEAN DEFAULT false,  -- system roles can't be deleted
  created_at      TIMESTAMP DEFAULT NOW()
);

CREATE TABLE permissions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resource        VARCHAR(50) NOT NULL,   -- e.g. 'quizzes', 'users'
  action          VARCHAR(50) NOT NULL,   -- e.g. 'create', 'delete'
  description     TEXT,
  created_at      TIMESTAMP DEFAULT NOW(),
  UNIQUE(resource, action)
);

CREATE TABLE user_roles (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role_id         UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  assigned_by     UUID REFERENCES users(id) ON DELETE SET NULL,
  assigned_at     TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, role_id)
);

CREATE TABLE role_permissions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id         UUID NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  permission_id   UUID NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  created_at      TIMESTAMP DEFAULT NOW(),
  UNIQUE(role_id, permission_id)
);

-- ──── QUIZ CORE ───────────────────────────────────────────

CREATE TABLE quiz_categories (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name            VARCHAR(100) NOT NULL,
  slug            VARCHAR(100) UNIQUE,
  icon            VARCHAR(10),
  sort_order      INTEGER DEFAULT 0,
  created_at      TIMESTAMP DEFAULT NOW()
);

CREATE TABLE quizzes (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title           VARCHAR(500) NOT NULL,
  description     TEXT,
  category_id     UUID REFERENCES quiz_categories(id) ON DELETE SET NULL,
  questions       JSONB NOT NULL,
  total_points    INTEGER DEFAULT 0,
  settings        JSONB DEFAULT '{}',
  visibility      quiz_visibility DEFAULT 'private',
  status          quiz_status DEFAULT 'draft',
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);

-- ──── SESSIONS & GAMEPLAY ─────────────────────────────────

CREATE TABLE quiz_sessions (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quiz_id           UUID NOT NULL REFERENCES quizzes(id) ON DELETE CASCADE,
  host_id           UUID NOT NULL REFERENCES users(id),
  status            session_status DEFAULT 'waiting',
  current_question  INTEGER DEFAULT 0,
  deep_link         TEXT,
  qr_code_url       TEXT,
  mezon_channel_id  VARCHAR(255),
  max_participants  INTEGER,
  started_at        TIMESTAMP,
  finished_at       TIMESTAMP,
  created_at        TIMESTAMP DEFAULT NOW()
);

CREATE TABLE session_participants (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      UUID NOT NULL REFERENCES quiz_sessions(id) ON DELETE CASCADE,
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  total_score     INTEGER DEFAULT 0,
  answers_count   INTEGER DEFAULT 0,
  correct_count   INTEGER DEFAULT 0,
  rank            INTEGER,
  joined_at       TIMESTAMP DEFAULT NOW(),
  UNIQUE(session_id, user_id)
);

CREATE TABLE answers (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id      UUID NOT NULL REFERENCES quiz_sessions(id) ON DELETE CASCADE,
  user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  question_index  INTEGER NOT NULL,
  selected_option INTEGER NOT NULL,
  is_correct      BOOLEAN NOT NULL,
  points_earned   INTEGER DEFAULT 0,
  response_time_ms INTEGER,
  answered_at     TIMESTAMP DEFAULT NOW(),
  UNIQUE(session_id, user_id, question_index)
);

-- ──── AUDIT LOG ───────────────────────────────────────────

CREATE TABLE audit_logs (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         UUID REFERENCES users(id) ON DELETE SET NULL,
  action          VARCHAR(100) NOT NULL,
  resource_type   VARCHAR(50),
  resource_id     UUID,
  details         JSONB,
  ip_address      INET,
  created_at      TIMESTAMP DEFAULT NOW()
);

-- ──── INDEXES ─────────────────────────────────────────────

CREATE INDEX idx_users_mezon_id ON users(mezon_user_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_user_roles_user ON user_roles(user_id);
CREATE INDEX idx_user_roles_role ON user_roles(role_id);
CREATE INDEX idx_role_perms_role ON role_permissions(role_id);
CREATE INDEX idx_quizzes_creator ON quizzes(creator_id);
CREATE INDEX idx_quizzes_status ON quizzes(status);
CREATE INDEX idx_quizzes_category ON quizzes(category_id);
CREATE INDEX idx_sessions_status ON quiz_sessions(status);
CREATE INDEX idx_sessions_quiz ON quiz_sessions(quiz_id);
CREATE INDEX idx_participants_session ON session_participants(session_id);
CREATE INDEX idx_participants_score ON session_participants(session_id, total_score DESC);
CREATE INDEX idx_answers_session ON answers(session_id, question_index);
CREATE INDEX idx_answers_user ON answers(user_id);
CREATE INDEX idx_audit_user ON audit_logs(user_id);
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_created ON audit_logs(created_at DESC);

-- ──── SEED: Default Roles ─────────────────────────────────

INSERT INTO roles (name, display_name, description, is_system) VALUES
  ('super_admin', 'Super Admin',   'Full system access, cannot be deleted', true),
  ('admin',       'Admin',         'Manage quizzes, users, sessions',       true),
  ('moderator',   'Moderator',     'Review & moderate content',             true),
  ('creator',     'Quiz Creator',  'Create & manage own quizzes',           false),
  ('player',      'Player',        'Join and play quizzes',                 false);

-- ──── SEED: Permissions ───────────────────────────────────

INSERT INTO permissions (resource, action, description) VALUES
  ('users',      'list',        'View user list'),
  ('users',      'view',        'View user detail'),
  ('users',      'create',      'Create new user'),
  ('users',      'update',      'Edit user info'),
  ('users',      'delete',      'Delete user'),
  ('users',      'assign_role', 'Assign roles to users'),
  ('roles',      'list',        'View role list'),
  ('roles',      'view',        'View role detail'),
  ('roles',      'create',      'Create new role'),
  ('roles',      'update',      'Edit role'),
  ('roles',      'delete',      'Delete role'),
  ('quizzes',    'list',        'View quiz list'),
  ('quizzes',    'view',        'View quiz detail'),
  ('quizzes',    'create',      'Create quiz'),
  ('quizzes',    'update',      'Edit quiz'),
  ('quizzes',    'delete',      'Delete quiz'),
  ('quizzes',    'publish',     'Publish quiz'),
  ('quizzes',    'moderate',    'Moderate quiz content'),
  ('sessions',   'list',        'View session list'),
  ('sessions',   'view',        'View session detail'),
  ('sessions',   'create',      'Create session'),
  ('sessions',   'start',       'Start a session'),
  ('sessions',   'end',         'End a session'),
  ('sessions',   'delete',      'Delete session'),
  ('reports',    'view',        'View reports'),
  ('reports',    'export',      'Export reports'),
  ('audit_logs', 'list',        'View audit log list'),
  ('audit_logs', 'view',        'View audit log detail'),
  ('settings',   'view',        'View system settings'),
  ('settings',   'update',      'Update system settings');

-- ──── HELPER: Check permission function ───────────────────

CREATE OR REPLACE FUNCTION user_has_permission(
  p_user_id UUID,
  p_resource VARCHAR,
  p_action VARCHAR
) RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN role_permissions rp ON ur.role_id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.id
    WHERE ur.user_id = p_user_id
      AND p.resource = p_resource
      AND p.action = p_action
  );
END;
$$ LANGUAGE plpgsql;